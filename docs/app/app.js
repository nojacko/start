(function(factory){!(typeof exports==="object"&&typeof module!=="undefined")&&typeof define==="function"&&define.amd?define(factory):factory()})(function(){"use strict";var BackgroundPost=function(post){this.post=post;this.url=this.post.url;this.thumbnailUrl=null;this.image=new Image};BackgroundPost.createFromJson=function(json){var obj=JSON.parse(json);var backgroundPost=new BackgroundPost(obj.post);backgroundPost.post=JSON.parse(obj.post);backgroundPost.url=obj.url;backgroundPost.thumbnailUrl=obj.thumbnailUrl;return backgroundPost};BackgroundPost.prototype.toJson=function(){return JSON.stringify({post:JSON.stringify(this.post),url:this.url,thumbnailUrl:this.thumbnailUrl})};BackgroundPost.prototype.post=null;BackgroundPost.prototype.isSuitable=function(){var url=new window.URI(this.url);if(url.hostname().search(/i\.imgur\.com/)>-1){var suffix=url.suffix();if(suffix==="gifv"){url.suffix("gif");this.url=url.toString();return true}if(suffix==="jpg"||suffix==="gif"||suffix==="png"){return true}}return false};BackgroundPost.prototype.loadImage=function(success,failure){var _this=this;this.image.onload=function(){if(_this.image.height===81&&_this.image.width===161){console.log("Error loading image (removed)",_this.url);if(failure){failure(_this)}return}console.log("Success loading image",_this.url);if(success){success(_this)}};this.image.onerror=function(){console.log("Error loading image (error)",_this.url);if(failure){failure(_this)}};this.image.src=this.url};var _BackgroundPost=BackgroundPost;var QueryParams={getByName:function(name){var match=RegExp("[?&]"+name+"=([^&]*)").exec(window.location.search);return match&&decodeURIComponent(match[1].replace(/\+/g," "))}};function shuffle(array){var currentIndex=array.length,temporaryValue,randomIndex;while(0!==currentIndex){randomIndex=Math.floor(Math.random()*currentIndex);currentIndex-=1;temporaryValue=array[currentIndex];array[currentIndex]=array[randomIndex];array[randomIndex]=temporaryValue}return array}var Settings=function(bag){this.bag=bag;this.reset();this.$elemSettings=jQuery("#settings");this.$elemSettingsIcon=jQuery("#settings-icon")};Settings.prototype.init=function(callback){var _this=this;this.$elemSettingsIcon.click(function(){_this.toggle()});$("#settings_save").click(function(){_this.save()});$("#settings_reset").click(function(){_this.reset();_this.save()});this.bag.get("settings",function(err,data){if(!err){_this.settings=JSON.parse(data);_this.update()}callback()})};Settings.prototype.update=function(){$("#settings_subreddit").val(this.settings.source);$("#settings_timing").val(this.settings.rotate)};Settings.prototype.reset=function(){this.settings={source:"EarthPorn",rotate:15*1e3,cacheTime:60*60};this.update()};Settings.prototype.save=function(){this.toggle();this.settings={source:$("#settings_subreddit").val(),rotate:$("#settings_timing").val(),cacheTime:60*60};this._save()};Settings.prototype._save=function(){this.bag.remove("last_background");this.bag.set("settings",JSON.stringify(this.settings),function(){window.location.reload()})};Settings.prototype.toggle=function(){this.$elemSettings.toggle()};Settings.prototype.get=function(setting){return typeof this.settings[setting]==="undefined"?null:this.settings[setting]};Settings.prototype.set=function(setting,value){this.settings[setting]=value};var _Settings=Settings;var Subreddit=function(bag){this.bag=bag};Subreddit.prototype.load=function(subreddit,cacheTime,callback){var _this=this,url="https://www.reddit.com/r/"+subreddit+".json?limit=100";this.bag.get(url,function(err,data){if(err){$.ajax({url:url,jsonp:"jsonp",dataType:"jsonp",data:data,success:function(data){_this.bag.set(url,data,cacheTime);_this.handleResponse(data,callback)},complete:function(){}})}else{_this.handleResponse(data,callback)}})};Subreddit.prototype.handleResponse=function(data,callback){var _this=this,isListing=data.kind&&data.kind==="Listing",hasData=typeof data.data==="object",hasChildren=typeof data.data.children==="object",children=null;if(isListing&&hasData&&hasChildren){children=data.data.children}callback(children)};var _Subreddit=Subreddit;var HomePage=function(){var _this=this;this.loopTimeout=null;this.bag=new window.Bag;this.settings=new _Settings(this.bag);this.subreddit=new _Subreddit(this.bag);this.$elemBackground=jQuery("#background");this.$elemBackground2=jQuery("#background_2");this.$elemBackgroundSource=jQuery("#background-source");this.$elemGreeting=jQuery("#greeting");this.$elemTime=jQuery("#time");this.$elemDate=jQuery("#date");this.date=null;this.lastSec=-1;this.lastMin=-1;this.lastHour=-1;this.lastDate=-1;this.possibleBackgrounds=[];this.changeImageFadeTime=1*1e3;this.delayNextBackgroundUpdate=false};HomePage.prototype.start=function(){var _this=this;this.settings.init(function(){_this.initBackgrounds();_this.subreddit.load(_this.settings.get("source"),_this.settings.get("cacheTime"),function(children){_this.getBackgroundsFromChildren(children)});_this.loop()})};HomePage.prototype.loop=function(){this.date=new Date;var sec=this.date.getSeconds();if(sec!==this.lastSec){this.updateTime();this.lastSec=sec;var min=this.date.getMinutes();if(min!==this.lastMin){this.lastMin=min;var date=this.date.getDate();if(date!==this.lastDate){this.updateDate();this.lastDate=date}var hour=this.date.getUTCHours();if(hour!==this.lastHour){this.updateGreeting();this.lastHour=hour}}}var _this=this;this.loopTimeout=window.setTimeout(function(){_this.loop()},500)};HomePage.prototype.updateTime=function(){var now=moment(),hoursMins=now.format("h:mm"),secs=now.format(":ss"),suffix=now.format("a");this.$elemTime.html(hoursMins+"<small>"+secs+"<br />"+suffix+"</small>")};HomePage.prototype.updateDate=function(){this.$elemDate.text(moment().format("D MMMM YYYY"))};HomePage.prototype.updateGreeting=function(){var now=moment(),day=now.format("dddd"),hour=parseInt(now.format("H")),timeOfDay="Morning";if(hour>=17){timeOfDay="Evening"}else if(hour>=12){timeOfDay="Afternoon"}this.$elemGreeting.text(day+" "+timeOfDay)};HomePage.prototype.initBackgrounds=function(){var _this=this;this.bag.get("last_background",function(error,data){if(error){return}var backgroundPost=_BackgroundPost.createFromJson(data);_this.possibleBackgrounds.push(backgroundPost);_this.updateBackground();_this.delayNextBackgroundUpdate=true})};HomePage.prototype.updateBackground=function(){if(this.delayNextBackgroundUpdate){this.delayNextBackgroundUpdate=false;return}var _this=this;if(this.possibleBackgrounds.length>0){var backgroundPost=this.possibleBackgrounds.shift();backgroundPost.loadImage(function(backgroundPost){_this.bag.set("last_background",backgroundPost.toJson());_this.possibleBackgrounds.push(backgroundPost);_this.$elemBackground2.css("background-image",'url("'+backgroundPost.url+'")');_this.$elemBackground.animate({opacity:0},_this.changeImageFadeTime,function(){_this.$elemBackgroundSource.css("opacity",0);_this.$elemBackground.css("background-image",'url("'+backgroundPost.url+'")').css("opacity",1);_this.$elemBackgroundSource.find("a").attr("href","https://reddit.com"+backgroundPost.post.permalink).text(backgroundPost.post.title);_this.$elemBackgroundSource.animate({opacity:1},_this.changeImageFadeTime/2)});if(_this.possibleBackgrounds.length>0){setTimeout(function(){_this.updateBackground()},_this.settings.get("rotate"))}},function(backgroundPost){_this.updateBackground()})}};HomePage.prototype.getBackgroundsFromChildren=function(children){this.possibleBackgrounds=[];if(children){var possibleBackgrounds=[];for(var i=0,len=children.length;i<len;i++){var child=children[i];if(child.kind=="t3"){var backgroundPost=new _BackgroundPost(child.data);if(backgroundPost.isSuitable()){possibleBackgrounds.push(backgroundPost)}}}if(possibleBackgrounds.length>1){this.possibleBackgrounds=possibleBackgrounds;this.possibleBackgrounds=shuffle(this.possibleBackgrounds);this.updateBackground()}}};var _HomePage=HomePage;var app=new _HomePage;app.start();ExternalLinks()});